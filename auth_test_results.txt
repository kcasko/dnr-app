2026-01-26 09:41:49,181 - app - WARNING - SECRET_KEY not set in environment. Using generated key.
2026-01-26 09:41:49,181 - app - WARNING - For production, set SECRET_KEY in .env file or environment variable.
2026-01-26 09:41:49,181 - app - INFO - Generated key (save this to .env): SECRET_KEY=88f455a7debe0e862e68b71283171c6c97f9bd26ec7874a741d0c92dcd3ef6d8
F.F.
======================================================================
FAIL: test_force_password_change (__main__.TestQAAuthentication)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "E:\Repos\dnr-app\qa_test_auth.py", line 164, in test_force_password_change
    self.assertIn(b'Password updated successfully', resp.data)
AssertionError: b'Password updated successfully' not found in b'<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="utf-8">\n    <meta name="viewport"\n        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">\n    <title>Shift Dashboard - Sleep Inn</title>\n\n    <!-- PWA / Mobile App Capabilities -->\n    <link rel="manifest" href="/static/manifest.json">\n    <meta name="theme-color" content="#4a2c6a">\n    <meta name="apple-mobile-web-app-capable" content="yes">\n    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">\n    <link rel="apple-touch-icon" href="/static/sleep_inn_logo.png">\n\n    <link rel="stylesheet" href="/static/styles.css">\n    \n</head>\n\n<body>\n    <a href="#main-content" class="skip-link">Skip to main content</a>\n\n    <!-- Simplified Top Header -->\n    <header class="app-header">\n        <div class="app-header-content">\n            <div class="header-left">\n                <button class="mobile-menu-btn" aria-label="Toggle Navigation">\n                    <span class="bar"></span>\n                    <span class="bar"></span>\n                    <span class="bar"></span>\n                </button>\n                <img src="/static/sleep_inn_logo.png" alt="Sleep Inn Logo" class="app-header-logo">\n            </div>\n            <div class="app-header-nav">\n                <a href="/overview" class="app-header-link">Overview</a>\n                <a href="/wakeup-calls"\n                    class="app-header-link ">\n                     Calls\n                    \n                </a>\n                <a href="/schedule" class="app-header-link">Schedule</a>\n                <a href="/settings" class="app-header-link">Settings</a>\n                <a href="/logout" class="app-header-link app-header-link-logout">Logout</a>\n            </div>\n        </div>\n    </header>\n\n    <!-- Sidebar Overlay (Mobile) -->\n    <div class="sidebar-overlay"></div>\n\n    <!-- Main Layout: Sidebar + Content -->\n    <div class="app-layout">\n        <!-- Persistent Sidebar Navigation -->\n        <aside class="app-sidebar">\n            <div class="sidebar-header-mobile">\n                <h3>Menu</h3>\n                <button class="sidebar-close-btn">&times;</button>\n            </div>\n            <nav class="sidebar-nav" aria-label="Main navigation">\n                <!-- Operations Section -->\n                <div class="sidebar-section">\n                    <div class="sidebar-section-label">Operations</div>\n                    <a href="/dnr" class="sidebar-link ">\n                        Do Not Rent List\n                    </a>\n                    <a href="/room-issues"\n                        class="sidebar-link ">\n                        Room Issues\n                    </a>\n                    <a href="/maintenance"\n                        class="sidebar-link ">\n                        Maintenance\n                    </a>\n                    <a href="/housekeeping-requests"\n                        class="sidebar-link ">\n                        Housekeeping\n                    </a>\n                </div>\n\n                <!-- Communication Section -->\n                <div class="sidebar-section">\n                    <div class="sidebar-section-label">Communication</div>\n                    <a href="/log-book" class="sidebar-link ">\n                        Shift Notes\n                    </a>\n                    <a href="/staff-announcements"\n                        class="sidebar-link ">\n                        Staff Notices\n                    </a>\n                    <a href="/in-house-messages"\n                        class="sidebar-link ">\n                        In-House Messages\n                    </a>\n                </div>\n\n                <!-- Quick Reference Section -->\n                <div class="sidebar-section">\n                    <div class="sidebar-section-label">Quick Reference</div>\n                    <a href="/important-numbers"\n                        class="sidebar-link ">\n                        Important Numbers\n                    </a>\n                    <a href="/how-to-guides"\n                        class="sidebar-link ">\n                        How-To Guides\n                    </a>\n                    <a href="/food-local-spots"\n                        class="sidebar-link ">\n                        Food & Local Spots\n                    </a>\n                    <a href="/cleaning-checklists"\n                        class="sidebar-link ">\n                        Cleaning Checklists\n                    </a>\n                </div>\n            </nav>\n        </aside>\n\n        <!-- Main Content Area -->\n        <main class="app-main" id="main-content">\n            <!-- Page Header -->\n            <div class="page-header">\n                <div class="page-header-content">\n                    <div class="page-title-section">\n                        <h1 class="page-title">Shift Dashboard</h1>\n                        \n<p class="page-subtitle">Operational snapshot - Last updated: 2026-01-26 09:41:50</p>\n\n                    </div>\n                    <div class="page-actions">\n                        \n                    </div>\n                </div>\n            </div>\n\n            <!-- Page Content -->\n            <div class="page-content">\n                \n\n<!-- Critical Alerts Section -->\n<div class="overview-alerts-section">\n    <h2 class="section-heading">Attention Needed</h2>\n    <div class="alert-cards-grid">\n        <!-- Urgent: Wake-up Calls -->\n        <a href="/wakeup-calls"\n            class="alert-card-link hidden"\n            id="card-wakeup">\n            <div class="alert-card alert-card-critical">\n                <div class="alert-card-icon"><span class="icon-dot-critical"></span></div>\n                <div class="alert-card-content">\n                    <div class="alert-card-label">Wake-up Calls Due</div>\n                    <div class="alert-card-count stat-number-heavy" id="count-wakeup">0</div>\n                    <div class="alert-card-action">View Calls \xe2\x86\x92</div>\n                </div>\n            </div>\n        </a>\n\n        <!-- Critical: Rooms Out of Order -->\n        <a href="/room-issues" class="alert-card-link"\n            id="card-ooo">\n            <div class="alert-card alert-card-critical">\n                <div class="alert-card-icon"><span class="icon-dot-critical"></span></div>\n                <div class="alert-card-content">\n                    <div class="alert-card-label">Rooms Out of Order</div>\n                    <div class="alert-card-count stat-number-heavy" id="count-ooo">1</div>\n                    <div class="alert-card-action">Resolve Issues \xe2\x86\x92</div>\n                </div>\n            </div>\n        </a>\n\n        <!-- Warning: Rooms Use If Needed -->\n        <a href="/room-issues" class="alert-card-link"\n            id="card-uin">\n            <div class="alert-card alert-card-warning">\n                <div class="alert-card-icon"><span class="icon-dot-warning"></span></div>\n                <div class="alert-card-content">\n                    <div class="alert-card-label">Rooms Use If Needed</div>\n                    <div class="alert-card-count stat-number-heavy" id="count-uin">1</div>\n                    <div class="alert-card-action">Review Rooms \xe2\x86\x92</div>\n                </div>\n            </div>\n        </a>\n    </div>\n</div>\n\n<!-- Awareness Section -->\n<div class="overview-awareness-section">\n    <h2 class="section-heading">Awareness</h2>\n    <div class="alert-cards-grid">\n        <!-- Active DNR Entries -->\n        <a href="/dnr" class="alert-card-link">\n            <div class="alert-card alert-card-flat">\n                <div class="alert-card-content">\n                    <div class="alert-card-label">Active DNR Records</div>\n                    <div class="alert-card-count" id="count-dnr">1</div>\n                    <div class="alert-card-action">Search List \xe2\x86\x92</div>\n                </div>\n            </div>\n        </a>\n\n        <!-- Open Maintenance Issues -->\n        <a href="/maintenance?status=open" class="alert-card-link">\n            <div class="alert-card alert-card-flat">\n                <div class="alert-card-content">\n                    <div class="alert-card-label">Open Maintenance</div>\n                    <div class="alert-card-count" id="count-maintenance">1</div>\n                    <div class="alert-card-action">Track Items \xe2\x86\x92</div>\n                </div>\n            </div>\n        </a>\n    </div>\n</div>\n\n<!-- What Just Happened Section -->\n<div class="overview-feed-section">\n    <h2 class="section-heading">What Just Happened</h2>\n    <p class="section-description">Recent shift notes from the last shift</p>\n\n    <div class="overview-feed">\n        \n        \n        <div class="feed-item">\n            <div class="feed-item-time">2026-01-26 01:31:56-05:00</div>\n            <div class="feed-item-text text-pre-wrap">Test Mobile Note\n\n(Added via mobile)</div>\n        </div>\n        \n        <div class="feed-item">\n            <div class="feed-item-time">2026-01-26 01:31:21-05:00</div>\n            <div class="feed-item-text text-pre-wrap">Test Mobile Note\n\n(Added via mobile)</div>\n        </div>\n        \n        <div class="feed-item">\n            <div class="feed-item-time">2026-01-26 01:30:50-05:00</div>\n            <div class="feed-item-text text-pre-wrap">Test Mobile Note\n\n(Added via mobile)</div>\n        </div>\n        \n\n        <div class="feed-action">\n            <a href="/log-book" class="btn-link">See all shift notes \xe2\x86\x92</a>\n        </div>\n        \n    </div>\n</div>\n\n<!-- Active Staff Notices Section -->\n\n\n\n            </div>\n        </main>\n    </div>\n\n    <!-- Footer -->\n    <footer class="app-footer">\n        <div class="app-footer-content">\n            <p>&copy; 2026 TaurusTechLLC. All rights reserved.</p>\n            <p class="footer-contact">For support or inquiries: <a\n                    href="mailto:keith@taurustech.me">keith@taurustech.me</a> | <a href="https://taurustech.me"\n                    target="_blank" rel="noopener">taurustech.me</a></p>\n        </div>\n    </footer>\n\n    <script>\n        document.addEventListener(\'DOMContentLoaded\', () => {\n            const menuBtn = document.querySelector(\'.mobile-menu-btn\');\n            const closeBtn = document.querySelector(\'.sidebar-close-btn\');\n            const sidebar = document.querySelector(\'.app-sidebar\');\n            const overlay = document.querySelector(\'.sidebar-overlay\');\n\n            function toggleMenu() {\n                sidebar.classList.toggle(\'active\');\n                overlay.classList.toggle(\'active\');\n            }\n\n            if (menuBtn) menuBtn.addEventListener(\'click\', toggleMenu);\n            if (closeBtn) closeBtn.addEventListener(\'click\', toggleMenu);\n            if (overlay) overlay.addEventListener(\'click\', toggleMenu);\n\n            // Register Service Worker for PWA\n            if (\'serviceWorker\' in navigator) {\n                navigator.serviceWorker.register(\'/static/sw.js\')\n                    .then(reg => console.log(\'Service Worker registered\', reg))\n                    .catch(err => console.log(\'Service Worker registration failed\', err));\n            }\n        });\n    </script>\n\n    \n<script>\n    // Overview Auto-Refresh Logic\n    const REFRESH_INTERVAL_MS = 30000; // 30 seconds\n\n    async function updateOverviewStats() {\n        try {\n            const response = await fetch(\'/api/overview-alerts\');\n            if (!response.ok) return;\n\n            const data = await response.json();\n\n            // Update Counts\n            const countOOO = document.getElementById(\'count-ooo\');\n            const cardOOO = document.getElementById(\'card-ooo\');\n            if (countOOO && cardOOO) {\n                countOOO.textContent = data.room_out_of_order_count;\n                cardOOO.classList.toggle(\'hidden\', data.room_out_of_order_count === 0);\n            }\n\n            const countWakeup = document.getElementById(\'count-wakeup\');\n            const cardWakeup = document.getElementById(\'card-wakeup\');\n            if (countWakeup && cardWakeup) {\n                countWakeup.textContent = data.wakeup_alert_count;\n                cardWakeup.classList.toggle(\'hidden\', data.wakeup_alert_count === 0);\n            }\n\n            const countUIN = document.getElementById(\'count-uin\');\n            const cardUIN = document.getElementById(\'card-uin\');\n            if (countUIN && cardUIN) {\n                countUIN.textContent = data.room_use_if_needed_count;\n                cardUIN.classList.toggle(\'hidden\', data.room_use_if_needed_count === 0);\n            }\n\n            const countDNR = document.getElementById(\'count-dnr\');\n            if (countDNR) {\n                countDNR.textContent = data.active_dnr_count;\n            }\n\n            const countMaint = document.getElementById(\'count-maintenance\');\n            if (countMaint) {\n                countMaint.textContent = data.open_maintenance_count;\n            }\n\n            // Update timestamp subtitle if possible (requires adding ID to base template or just replacing text content)\n            const subtitle = document.querySelector(\'.page-subtitle\');\n            if (subtitle) {\n                subtitle.textContent = `Operational snapshot - Last updated: ${data.last_updated}`;\n            }\n\n        } catch (error) {\n            console.error(\'Failed to refresh overview stats:\', error);\n        }\n    }\n\n    // Start polling\n    setInterval(updateOverviewStats, REFRESH_INTERVAL_MS);\n</script>\n\n</body>\n\n</html>'

======================================================================
FAIL: test_user_management (__main__.TestQAAuthentication)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "E:\Repos\dnr-app\qa_test_auth.py", line 123, in test_user_management
    self.assertEqual(user['is_active'], 0)
AssertionError: 1 != 0

----------------------------------------------------------------------
Ran 4 tests in 4.602s

FAILED (failures=2)

--- Testing Forced Password Change ---
[Pass] User redirected to change password on first login
[Pass] User cannot access other pages until password changed

--- Testing Login Behavior ---
[Pass] Manager login success
[Pass] Regular user login success
[Pass] Incorrect password fails cleanly
[Pass] Deactivated user cannot login

--- Testing User Management ---
[Pass] Manager can add user
[Pass] New user has force_password_change=1

--- Testing Visibility ---
[Pass] Manager sees Admin Settings
[Pass] Regular user does NOT see Admin Settings
