{% extends "base.html" %}

{% block title %}Weekly Schedule{% endblock %}

{% block page_title %}Weekly Schedule{% endblock %}

{% block page_actions %}
<div class="schedule-top-controls">
    <!-- Week Navigation -->
    <div class="week-nav">
        <a href="{{ url_for('view_schedule', week_start=prev_week_start.isoformat(), view=request.args.get('view', 'shift')) }}"
            class="btn btn-secondary">&larr; Prev Week</a>
        <span class="current-week-label">Week of {{ current_week_start.strftime('%b %d, %Y') }}</span>
        <a href="{{ url_for('view_schedule', week_start=next_week_start.isoformat(), view=request.args.get('view', 'shift')) }}"
            class="btn btn-secondary">Next Week &rarr;</a>
    </div>

    <!-- View Toggle -->
    <div class="schedule-actions">
        <div class="view-toggle">
            <button class="toggle-btn {% if request.args.get('view') != 'paper' %}active{% endif %}"
                onclick="switchView('shift')">Edit Schedule</button>
            <button class="toggle-btn {% if request.args.get('view') == 'paper' %}active{% endif %}"
                onclick="switchView('paper')">View Schedule</button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}

<!-- Shift-Based View (Original) -->
<!-- Department-Based View -->
<div id="department-view" class="schedule-view {% if request.args.get('view') == 'paper' %}hidden{% endif %}">
    <div class="schedule-container">
        <div class="schedule-grid">
            <!-- Header Row -->
            <div class="schedule-header-cell">Department</div>
            {% for day in week_dates %}
            <div class="schedule-header-cell {% if day.isoformat() == today_iso %}today-highlight{% endif %}">
                <div class="dow">{{ day.strftime('%A') }}</div>
                <div class="date">{{ day.strftime('%b %d') }}</div>
            </div>
            {% endfor %}

            <!-- Department Rows -->
            {% for department in departments %}

            <!-- Department Label Column -->
            <div class="schedule-department-header">{{ department }}</div>

            <!-- Days Columns -->
            {% for day in week_dates %}
            {% set day_iso = day.isoformat() %}
            <div class="schedule-cell {% if day.isoformat() == today_iso %}today-highlight{% endif %}">
                {% set staff_list = department_grid[department].get(day_iso, []) %}

                <div class="assignments-list">
                    {% for staff in staff_list %}
                    <div class="assignment-chip-group">
                        <div class="assign-name-header"><strong>{{ staff.name }}</strong></div>

                        {% for shift in staff.shifts %}
                        <div class="assignment-chip">
                            <div class="assign-info">
                                {% if shift.time %}
                                <span class="assign-time">{{ shift.time }}</span><br>
                                {% endif %}
                                {% if shift.role and shift.role != staff.role %}
                                <span class="assign-role">{{ shift.role }}</span>
                                {% endif %}
                                {% if shift.note %}
                                <span class="assign-note" title="{{ shift.note }}">üìù</span>
                                {% endif %}
                            </div>

                            {% if session.role == 'manager' %}
                            <form action="{{ url_for('update_schedule') }}" method="POST" class="remove-form"
                                onsubmit="return confirm('Remove {{ shift.time }} shift for {{ staff.name }}?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="action" value="remove">
                                <input type="hidden" name="schedule_id" value="{{ shift.id }}">
                                <input type="hidden" name="week_start" value="{{ current_week_start.isoformat() }}">
                                <button type="submit" class="btn-remove" title="Remove">&times;</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>

                {% if session.role == 'manager' %}
                <!-- Use Shift ID 1 as placeholder since we removed shift rows, modal handles it -->
                <button type="button" class="btn-add-staff"
                    onclick="openAddModal('{{ day_iso }}', 1, '{{ department }}')">+</button>
                {% endif %}
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Paper-Style Layout (Embedded) -->
<div id="paper-view" class="schedule-view {% if request.args.get('view') != 'paper' %}hidden{% endif %}">
    <div class="paper-schedule-container">
        <h2 class="paper-schedule-title">SLEEP INN & SUITES KALAMAZOO</h2>

        <table class="paper-schedule-table">
            <!-- Header Row -->
            <thead>
                <tr>
                    <th class="staff-column">Staff</th>
                    {% for day in week_dates %}
                    <th class="day-column {% if day.isoformat() == today_iso %}today-highlight{% endif %}">
                        <div class="day-name">{{ day.strftime('%a').upper() }}</div>
                        <div class="day-date">{{ day.strftime('%m/%d') }}</div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for department in ['FRONT DESK', 'HOUSEKEEPING', 'BREAKFAST ATTENDANT', 'LAUNDRY', 'MAINTENANCE',
                'INSPECTING'] %}
                {% set dept_staff = paper_schedule_data.get(department, {}) %}
                {% if dept_staff %}
                <!-- Department Header -->
                <tr class="department-header">
                    <td colspan="8">{{ department }}</td>
                </tr>

                <!-- Staff Rows -->
                {% for staff_name, staff_info in dept_staff.items() %}
                <tr class="staff-row">
                    <td class="staff-cell">
                        <div class="staff-name">{{ staff_name }}</div>
                        {% if staff_info.phone %}
                        <div class="staff-phone">{{ staff_info.phone }}</div>
                        {% endif %}
                    </td>
                    {% for day in week_dates %}
                    {% set day_iso = day.isoformat() %}
                    <td class="shift-cell {% if day_iso == today_iso %}today-highlight{% endif %}">
                        {{ staff_info.days.get(day_iso, '') }}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Upload Schedule Modal (Manager Only) -->
{% if session.role == 'manager' %}
<div id="uploadScheduleModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close" onclick="closeUploadModal()">&times;</span>
        <h3>Upload Schedule</h3>
        <p>Upload a PDF or DOCX file containing your weekly schedule.</p>

        <form id="uploadForm" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="week_start" value="{{ current_week_start.isoformat() }}">

            <div class="form-group">
                <label for="schedule_file">Select File (PDF or DOCX)</label>
                <input type="file" id="schedule_file" name="schedule_file" accept=".pdf,.docx" required>
                <small>Maximum file size: 16MB</small>
            </div>

            <div id="uploadStatus" class="upload-status"></div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary" id="uploadBtn">Upload & Preview</button>
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Staff Modal (Updated for Paper Format) -->
<div id="addStaffModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h3>Assign Staff</h3>
        <p id="modalDateDisplay"></p>

        <form action="{{ url_for('update_schedule') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="week_start" value="{{ current_week_start.isoformat() }}">
            <input type="hidden" id="modalDate" name="shift_date">
            <input type="hidden" id="modalShift" name="shift_id" value="1">

            <div class="form-group">
                <label for="user_id">Select User</label>
                <select id="user_id" name="user_id" onchange="toggleCustomName()">
                    <option value="">-- Select Registered User --</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}">{{ user.username }} ({{ user.role|replace('_',' ')|title }})</option>
                    {% endfor %}
                    <option value="custom">Other Staff...</option>
                </select>
            </div>

            <div class="form-group hidden" id="customNameGroup">
                <label for="custom_name">Staff Name</label>
                <input type="text" id="custom_name" name="custom_name" placeholder="E.g. Maria, John">
            </div>

            <div class="form-group">
                <label for="department">Department</label>
                <select id="department" name="department">
                    <option value="FRONT DESK">Front Desk</option>
                    <option value="HOUSEKEEPING">Housekeeping</option>
                    <option value="BREAKFAST ATTENDANT">Breakfast Attendant</option>
                    <option value="LAUNDRY">Laundry</option>
                </select>
            </div>

            <div class="form-group">
                <label for="shift_time">Shift Time</label>
                <select id="shift_time" name="shift_time">
                    <option value="7am-3pm">7am - 3pm</option>
                    <option value="3pm-11pm">3pm - 11pm</option>
                    <option value="11pm-7am">11pm - 7am</option>
                    <option value="ON">ON (On-Call)</option>
                    <option value="custom">Custom Time...</option>
                </select>
            </div>

            <div class="form-group hidden" id="customTimeGroup">
                <label for="custom_time">Custom Time</label>
                <input type="text" id="custom_time" name="custom_time" placeholder="E.g. 9am-5pm">
            </div>

            <div class="form-group">
                <label for="phone_number">Phone Number (Optional)</label>
                <input type="text" id="phone_number" name="phone_number" placeholder="555-123-4567">
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Assign</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    // View Toggle
    function switchView(view) {
        const url = new URL(window.location.href);
        url.searchParams.set('view', view);
        window.location.href = url.toString();
    }


    // Upload Modal
    function openUploadModal() {
        document.getElementById('uploadScheduleModal').classList.add('active');
    }

    function closeUploadModal() {
        document.getElementById('uploadScheduleModal').classList.remove('active');
        document.getElementById('uploadForm').reset();
        document.getElementById('uploadStatus').innerHTML = '';
    }

    // Handle upload form submission
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const statusDiv = document.getElementById('uploadStatus');
        const uploadBtn = document.getElementById('uploadBtn');

        uploadBtn.disabled = true;
        statusDiv.innerHTML = '<p class="status-loading">Uploading and parsing schedule...</p>';

        try {
            const response = await fetch('{{ url_for("upload_schedule") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // Redirect to preview page
                window.location.href = result.preview_url;
            } else {
                statusDiv.innerHTML = `<p class="status-error">Error: ${result.error}</p>`;
                uploadBtn.disabled = false;
            }
        } catch (error) {
            statusDiv.innerHTML = '<p class="status-error">Upload failed. Please try again.</p>';
            uploadBtn.disabled = false;
        }
    });

    // Add Staff Modal
    function openAddModal(dateIso, shiftId, department) {
        document.getElementById('modalDate').value = dateIso;
        document.getElementById('modalShift').value = shiftId || 1;

        const dateObj = new Date(dateIso + "T00:00:00");
        const options = { weekday: 'long', month: 'short', day: 'numeric' };
        document.getElementById('modalDateDisplay').textContent = dateObj.toLocaleDateString(undefined, options);

        if (department) {
            const deptSelect = document.getElementById('department');
            deptSelect.value = department;
        }

        // Default shift time to the selected shift in shift view
        const shiftTimeSelect = document.getElementById('shift_time');
        if (shiftId === 1) {
            shiftTimeSelect.value = '7am-3pm';
        } else if (shiftId === 2) {
            shiftTimeSelect.value = '3pm-11pm';
        } else if (shiftId === 3) {
            shiftTimeSelect.value = '11pm-7am';
        }

        document.getElementById('addStaffModal').classList.add('active');
        toggleCustomName();
        toggleCustomTime();
    }

    function closeAddModal() {
        document.getElementById('addStaffModal').classList.remove('active');
    }

    function toggleCustomName() {
        const select = document.getElementById('user_id');
        const customGroup = document.getElementById('customNameGroup');
        if (select.value === 'custom' || select.value === '') {
            customGroup.classList.remove('hidden');
        } else {
            customGroup.classList.add('hidden');
            document.getElementById('custom_name').value = '';
        }
    }

    function toggleCustomTime() {
        const select = document.getElementById('shift_time');
        const customGroup = document.getElementById('customTimeGroup');
        if (select.value === 'custom') {
            customGroup.classList.remove('hidden');
        } else {
            customGroup.classList.add('hidden');
            document.getElementById('custom_time').value = '';
        }
    }

    document.getElementById('shift_time').addEventListener('change', toggleCustomTime);

    // Close modals when clicking outside
    window.onclick = function (event) {
        const addModal = document.getElementById('addStaffModal');
        const uploadModal = document.getElementById('uploadScheduleModal');

        if (event.target == addModal) {
            addModal.classList.remove('active');
        }
        if (event.target == uploadModal) {
            closeUploadModal();
        }
    }
</script>
{% endif %}

{% endblock %}