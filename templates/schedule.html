{% extends "base.html" %}

{% block title %}Weekly Schedule{% endblock %}

{% block page_title %}Weekly Schedule{% endblock %}

{% block page_actions %}
<div class="schedule-top-controls">
    <div class="week-nav">
        <a href="{{ url_for('view_schedule', week_start=prev_week_start.isoformat(), mode=mode) }}"
            class="btn btn-secondary">&larr; Prev Week</a>
        <span class="current-week-label">Week of {{ week_range_label }}</span>
        <a href="{{ url_for('view_schedule', week_start=next_week_start.isoformat(), mode=mode) }}"
            class="btn btn-secondary">Next Week &rarr;</a>
    </div>

    {% if session.role == 'manager' %}
    <div class="schedule-actions">
        {% if mode == 'edit' %}
        <a href="{{ url_for('view_schedule', week_start=current_week_start.isoformat(), mode='view') }}"
            class="btn btn-secondary">Done</a>
        {% else %}
        <a href="{{ url_for('view_schedule', week_start=current_week_start.isoformat(), mode='edit') }}"
            class="btn btn-primary">Edit Schedule</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="paper-schedule-container">
    <h2 class="paper-schedule-title">SLEEP INN & SUITES KALAMAZOO</h2>

    <table class="paper-schedule-table">
        <!-- Header Row -->
        <thead>
            <tr>
                <th class="staff-column">Staff</th>
                {% for day in week_dates %}
                <th class="day-column {% if day.isoformat() == today_iso %}today-highlight{% endif %}">
                    <div class="day-name">{{ day.strftime('%a').upper() }}</div>
                    <div class="day-date">{{ day.strftime('%m/%d') }}</div>
                </th>
                {% endfor %}
            </tr>
        </thead>

        <tbody>
            {% for department in departments %}
            {% set dept_staff = paper_schedule_data.get(department, {}) %}
            {% if dept_staff %}
            <!-- Department Header -->
            <tr class="department-header">
                <td colspan="8">{{ department }}</td>
            </tr>

            <!-- Staff Rows -->
            {% for staff_name, staff_info in dept_staff.items() %}
            <tr class="staff-row">
                <td class="staff-cell">
                    <div class="staff-name">{{ staff_name }}</div>
                    {% if staff_info.phone %}
                    <div class="staff-phone">{{ staff_info.phone }}</div>
                    {% endif %}
                </td>
                {% for day in week_dates %}
                {% set day_iso = day.isoformat() %}
                {% set shifts = staff_info.days.get(day_iso, []) %}
                <td class="shift-cell {% if day_iso == today_iso %}today-highlight{% endif %}">
                    {% if shifts %}
                        {% if mode == 'edit' and session.role == 'manager' %}
                            {% for shift in shifts %}
                                <div class="shift-line">
                                    <span>{{ shift.time or shift.role }}</span>
                                    <form action="{{ url_for('update_schedule') }}" method="POST" class="remove-form"
                                        onsubmit="return confirm('Remove {{ shift.time }} shift for {{ staff_name }}?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="action" value="remove">
                                        <input type="hidden" name="schedule_id" value="{{ shift.id }}">
                                        <input type="hidden" name="week_start" value="{{ current_week_start.isoformat() }}">
                                        <button type="submit" class="btn-remove" title="Remove">&times;</button>
                                    </form>
                                </div>
                            {% endfor %}
                        {% else %}
                            {% set ns = namespace(parts=[]) %}
                            {% for shift in shifts %}
                                {% set ns.parts = ns.parts + [shift.time or shift.role] %}
                            {% endfor %}
                            {{ ns.parts | join(' / ') }}
                        {% endif %}
                    {% endif %}
                    {% if mode == 'edit' and session.role == 'manager' %}
                        <button type="button" class="btn-add-staff"
                            onclick="openAddModal('{{ day_iso }}', 1, '{{ department }}')">+</button>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% if session.role == 'manager' %}
<div id="addStaffModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h3>Assign Staff</h3>
        <p id="modalDateDisplay"></p>

        <form action="{{ url_for('update_schedule') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="week_start" value="{{ current_week_start.isoformat() }}">
            <input type="hidden" id="modalDate" name="shift_date">
            <input type="hidden" id="modalShift" name="shift_id" value="1">

            <div class="form-group">
                <label for="user_id">Select User</label>
                <select id="user_id" name="user_id" onchange="toggleCustomName()">
                    <option value="">-- Select Registered User --</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}">{{ user.username }} ({{ user.role|replace('_',' ')|title }})</option>
                    {% endfor %}
                    <option value="custom">Other Staff...</option>
                </select>
            </div>

            <div class="form-group hidden" id="customNameGroup">
                <label for="custom_name">Staff Name</label>
                <input type="text" id="custom_name" name="custom_name" placeholder="E.g. Maria, John">
            </div>

            <div class="form-group">
                <label for="department">Department</label>
                <select id="department" name="department">
                    <option value="FRONT DESK">Front Desk</option>
                    <option value="HOUSEKEEPING">Housekeeping</option>
                    <option value="BREAKFAST ATTENDANT">Breakfast Attendant</option>
                    <option value="LAUNDRY">Laundry</option>
                </select>
            </div>

            <div class="form-group">
                <label for="shift_time">Shift Time</label>
                <select id="shift_time" name="shift_time">
                    <option value="7am-3pm">7am - 3pm</option>
                    <option value="3pm-11pm">3pm - 11pm</option>
                    <option value="11pm-7am">11pm - 7am</option>
                    <option value="ON">ON (On-Call)</option>
                    <option value="custom">Custom Time...</option>
                </select>
            </div>

            <div class="form-group hidden" id="customTimeGroup">
                <label for="custom_time">Custom Time</label>
                <input type="text" id="custom_time" name="custom_time" placeholder="E.g. 9am-5pm">
            </div>

            <div class="form-group">
                <label for="phone_number">Phone Number (Optional)</label>
                <input type="text" id="phone_number" name="phone_number" placeholder="555-123-4567">
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Assign</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openAddModal(dateIso, shiftId, department) {
        document.getElementById('modalDate').value = dateIso;
        document.getElementById('modalShift').value = shiftId || 1;

        const dateObj = new Date(dateIso + "T00:00:00");
        const options = { weekday: 'long', month: 'short', day: 'numeric' };
        document.getElementById('modalDateDisplay').textContent = dateObj.toLocaleDateString(undefined, options);

        if (department) {
            const deptSelect = document.getElementById('department');
            deptSelect.value = department;
        }

        const shiftTimeSelect = document.getElementById('shift_time');
        if (shiftId === 1) {
            shiftTimeSelect.value = '7am-3pm';
        } else if (shiftId === 2) {
            shiftTimeSelect.value = '3pm-11pm';
        } else if (shiftId === 3) {
            shiftTimeSelect.value = '11pm-7am';
        }

        document.getElementById('addStaffModal').classList.add('active');
        toggleCustomName();
        toggleCustomTime();
    }

    function closeAddModal() {
        document.getElementById('addStaffModal').classList.remove('active');
    }

    function toggleCustomName() {
        const select = document.getElementById('user_id');
        const customGroup = document.getElementById('customNameGroup');
        if (select.value === 'custom' || select.value === '') {
            customGroup.classList.remove('hidden');
        } else {
            customGroup.classList.add('hidden');
            document.getElementById('custom_name').value = '';
        }
    }

    function toggleCustomTime() {
        const select = document.getElementById('shift_time');
        const customGroup = document.getElementById('customTimeGroup');
        if (select.value === 'custom') {
            customGroup.classList.remove('hidden');
        } else {
            customGroup.classList.add('hidden');
            document.getElementById('custom_time').value = '';
        }
    }

    const shiftTimeSelect = document.getElementById('shift_time');
    if (shiftTimeSelect) {
        shiftTimeSelect.addEventListener('change', toggleCustomTime);
    }

    window.onclick = function (event) {
        const addModal = document.getElementById('addStaffModal');
        if (event.target == addModal) {
            addModal.classList.remove('active');
        }
    }
</script>
{% endif %}

{% endblock %}
