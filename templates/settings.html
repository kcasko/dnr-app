{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="settings-container">

    <div class="tabs">
        <button class="tab-link active" onclick="openTab(event, 'MySettings')">My Settings</button>
        {% if session.role == 'manager' %}
        <button class="tab-link" onclick="openTab(event, 'UserManagement')">User Management</button>
        {% endif %}
    </div>

    <!-- My Settings Tab -->
    <div id="MySettings" class="tab-content active-tab">
        <div class="card">
            <h3>Preferences</h3>
            <form action="{{ url_for('update_preferences') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" name="wakeup_calls" {% if current_user.notification_preferences
                            and 'true' in current_user.notification_preferences %}checked{% endif %}>
                        <span class="checkmark"></span>
                        Enable Wake-up Call Notifications (on active shift)
                    </label>
                    <small class="form-hint">You will only be notified if you are working the current shift.</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Preferences</button>
                </div>
            </form>
        </div>

        <div class="card card-mt">
            <h3>Security</h3>
            <p>Update your password regularly to keep your account secure.</p>
            <a href="{{ url_for('change_password') }}" class="btn btn-secondary">Change Password</a>
        </div>
    </div>

    {% if session.role == 'manager' %}
    <!-- User Management Tab (Manager Only) -->
    <div id="UserManagement" class="tab-content">

        <!-- Add User Card -->
        <div class="card">
            <h3>Add New User</h3>
            <form action="{{ url_for('add_user') }}" method="POST" class="inline-form"
                onsubmit="return validatePasswordStrength(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required minlength="3" placeholder="jdoe">
                </div>

                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" name="role">
                        <option value="front_desk">Front Desk</option>
                        <option value="night_audit">Night Audit</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="password">Temporary Password</label>
                    <input type="password" id="password" name="password" required minlength="8" placeholder="********"
                        oninput="validatePassword(this)">
                    <small class="form-hint">
                        Must be at least 8 characters with uppercase, lowercase, and numbers
                    </small>
                    <div id="password-strength" class="hidden">
                        <span id="strength-upper" class="strength-req">‚úó Uppercase</span>
                        <span id="strength-lower" class="strength-req">‚úó Lowercase</span>
                        <span id="strength-number" class="strength-req">‚úó Number</span>
                        <span id="strength-length" class="strength-req">‚úó 8+ chars</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="create-user-btn">Create User</button>
            </form>
        </div>

        <!-- User List -->
        <div class="card card-mt">
            <h3>Active Users</h3>

            {% if request.args.get('success') %}
            <div class="alert alert-success">{{ request.args.get('success') }}</div>
            {% endif %}
            {% if request.args.get('error') %}
            <div class="alert alert-danger">{{ request.args.get('error') }}</div>
            {% endif %}

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="{% if not user.is_active %}inactive-row{% endif %}">
                            <td>{{ user.username }}</td>
                            <td><span class="badge badge-role">{{ user.role|replace('_', ' ')|title }}</span></td>
                            <td>
                                {% if user.is_active %}
                                <span class="status-indicator status-active">Active</span>
                                {% else %}
                                <span class="status-indicator status-inactive">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.last_login %}
                                {{ user.last_login[:16].replace('T', ' ') }}
                                {% else %}
                                <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                {% if user.id != session.user_id %}
                                <form action="{{ url_for('toggle_user_active', user_id=user.id) }}" method="POST"
                                    class="inline-form" onsubmit="return confirm('Are you sure?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn-icon"
                                        title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}">
                                        {% if user.is_active %}‚ùå{% else %}‚úÖ{% endif %}
                                    </button>
                                </form>
                                <button type="button" class="btn-icon"
                                    onclick="openResetModal('{{ user.id }}', '{{ user.username }}')"
                                    title="Reset Password">
                                    üîë
                                </button>
                                {% else %}
                                <span class="text-muted">(You)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Reset Password Modal -->
<div id="resetModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close" onclick="closeResetModal()">&times;</span>
        <h3>Reset Password for <span id="resetUsername"></span></h3>
        <p>Enter a new temporary password. The user will be forced to change it on next login.</p>

        <form id="resetForm" action="" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="new_password">New Temporary Password</label>
                <input type="password" id="new_password" name="new_password" required minlength="8">
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-warning">Reset Password</button>
                <button type="button" class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active-tab");
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).classList.add("active-tab");
        evt.currentTarget.classList.add("active");
    }

    function openResetModal(userId, username) {
        document.getElementById('resetUsername').textContent = username;
        document.getElementById('resetForm').action = "/settings/users/" + userId + "/reset";
        document.getElementById('resetModal').classList.add('active');
    }

    function closeResetModal() {
        document.getElementById('resetModal').classList.remove('active');
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        var modal = document.getElementById('resetModal');
        if (event.target == modal) {
            modal.classList.remove('active');
        }
    }

    function validatePassword(input) {
        const password = input.value;
        const strengthDiv = document.getElementById('password-strength');
        const submitBtn = document.getElementById('create-user-btn');

        if (password.length === 0) {
            strengthDiv.classList.add('hidden');
            return;
        }

        strengthDiv.classList.remove('hidden');

        // Check requirements
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasLength = password.length >= 8;

        // Update UI
        updateReq('strength-upper', hasUpper);
        updateReq('strength-lower', hasLower);
        updateReq('strength-number', hasNumber);
        updateReq('strength-length', hasLength);

        // Enable/disable submit
        const allValid = hasUpper && hasLower && hasNumber && hasLength;
        submitBtn.disabled = !allValid;
    }

    function updateReq(id, valid) {
        const elem = document.getElementById(id);
        if (valid) {
            elem.textContent = elem.textContent.replace('‚úó', '‚úì');
            elem.style.color = 'green';
        } else {
            elem.textContent = elem.textContent.replace('‚úì', '‚úó');
            elem.style.color = 'red';
        }
    }

    function validatePasswordStrength(event) {
        const password = document.getElementById('password').value;
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasLength = password.length >= 8;

        if (!hasUpper || !hasLower || !hasNumber || !hasLength) {
            alert('Password must contain uppercase, lowercase, number, and be at least 8 characters');
            event.preventDefault();
            return false;
        }
        return true;
    }
</script>
{% endblock %}