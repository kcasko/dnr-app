{% extends "base.html" %}

{% block title %}Shift Dashboard{% endblock %}

{% block page_title %}Shift Dashboard{% endblock %}

{% block page_subtitle %}
<p class="page-subtitle">Operational snapshot - Last updated: {{ last_updated }}</p>
{% endblock %}

{% block content %}

<!-- Critical Alerts Section -->
<div class="overview-alerts-section">
    <h2 class="section-heading">Attention Needed</h2>
    <div class="alert-cards-grid">
        <!-- Urgent: Wake-up Calls -->
        <a href="/wakeup-calls"
            class="alert-card-link{% if not wakeup_alert_count or wakeup_alert_count==0 %} hidden{% endif %}"
            id="card-wakeup">
            <div class="alert-card alert-card-critical">
                <div class="alert-card-icon"><span class="icon-dot-critical"></span></div>
                <div class="alert-card-content">
                    <div class="alert-card-label">Wake-up Calls Due</div>
                    <div class="alert-card-count stat-number-heavy" id="count-wakeup">{{ wakeup_alert_count }}</div>
                    <div class="alert-card-action">View Calls ‚Üí</div>
                </div>
            </div>
        </a>

        <!-- Critical: Rooms Out of Order -->
        <a href="/room-issues" class="alert-card-link{% if room_out_of_order_count==0 %} hidden{% endif %}"
            id="card-ooo">
            <div class="alert-card alert-card-critical">
                <div class="alert-card-icon"><span class="icon-dot-critical"></span></div>
                <div class="alert-card-content">
                    <div class="alert-card-label">Rooms Out of Order</div>
                    <div class="alert-card-count stat-number-heavy" id="count-ooo">{{ room_out_of_order_count }}</div>
                    <div class="alert-card-action">View Issues ‚Üí</div>
                </div>
            </div>
        </a>

        <!-- Warning: Hot Water Issues -->
        <a href="/room-issues" class="alert-card-link{% if hot_water_issue_count==0 %} hidden{% endif %}"
            id="card-hot-water">
            <div class="alert-card alert-card-hot-water">
                <div class="alert-card-icon"><span class="icon-hot-water">üíß</span></div>
                <div class="alert-card-content">
                    <div class="alert-card-label">Hot Water Issues</div>
                    <div class="alert-card-count stat-number-heavy" id="count-hot-water">{{ hot_water_issue_count }}</div>
                    <div class="alert-card-action">View Rooms ‚Üí</div>
                </div>
            </div>
        </a>

        <!-- Warning: Rooms Limited Use -->
        <a href="/room-issues" class="alert-card-link{% if room_limited_use_count==0 %} hidden{% endif %}"
            id="card-limited-use">
            <div class="alert-card alert-card-warning">
                <div class="alert-card-icon"><span class="icon-dot-warning"></span></div>
                <div class="alert-card-content">
                    <div class="alert-card-label">Rooms Limited Use</div>
                    <div class="alert-card-count stat-number-heavy" id="count-limited-use">{{ room_limited_use_count }}</div>
                    <div class="alert-card-action">View Rooms ‚Üí</div>
                </div>
            </div>
        </a>
    </div>

    <!-- Active Room Issues List (compact display) -->
    {% if active_room_issues %}
    <div class="room-issues-summary">
        <h3 class="summary-heading">Active Room Issues</h3>
        <div class="room-issues-grid">
            {% for issue in active_room_issues %}
            <span class="room-issue-chip {% if issue.issue_type == 'Hot Water' %}hot-water-chip{% endif %}">
                <span class="room-number">{{ issue.room_number }}</span>
                <span class="issue-indicator">
                    {% if issue.issue_type == 'Hot Water' %}üíß
                    {% elif issue.issue_type == 'HVAC' %}üå°Ô∏è
                    {% elif issue.issue_type == 'Plumbing' %}üîß
                    {% else %}‚ö†Ô∏è
                    {% endif %}
                </span>
                <span class="issue-type-label">{{ issue.issue_type }}</span>
            </span>
            {% endfor %}
        </div>
        <div class="summary-action">
            <a href="/room-issues" class="btn-link">View all room issues ‚Üí</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Awareness Section -->
<div class="overview-awareness-section">
    <h2 class="section-heading">Awareness</h2>
    <div class="alert-cards-grid">
        <!-- Active DNR Entries -->
        <a href="/dnr" class="alert-card-link">
            <div class="alert-card alert-card-flat">
                <div class="alert-card-content">
                    <div class="alert-card-label">Active DNR Records</div>
                    <div class="alert-card-count" id="count-dnr">{{ active_dnr_count }}</div>
                    <div class="alert-card-action">View List ‚Üí</div>
                </div>
            </div>
        </a>

        <!-- Open Maintenance Issues -->
        <a href="/maintenance?status=open" class="alert-card-link">
            <div class="alert-card alert-card-flat">
                <div class="alert-card-content">
                    <div class="alert-card-label">Open Maintenance</div>
                    <div class="alert-card-count" id="count-maintenance">{{ open_maintenance_count }}</div>
                    <div class="alert-card-action">View Items ‚Üí</div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- What Just Happened Section -->
<div class="overview-feed-section">
    <h2 class="section-heading">What Just Happened</h2>
    <p class="section-description">Recent shift notes from the last shift</p>

    <div class="overview-feed">
        {% if recent_notes %}
        {% for note in recent_notes[:3] %}
        <div class="feed-item">
            <div class="feed-item-time">{{ note.created_at }}</div>
            <div class="feed-item-text text-pre-wrap">{{ note.note }}</div>
        </div>
        {% endfor %}

        <div class="feed-action">
            <a href="/log-book" class="btn-link">See all shift notes ‚Üí</a>
        </div>
        {% else %}
        <div class="empty-state-compact">
            <p>No shift notes yet. Shift notes will appear here as they are added.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Active Staff Notices Section -->
{% if announcements %}
<div class="overview-notices-section">
    <h2 class="section-heading">Active Staff Notices</h2>
    <div class="notices-feed">
        {% for announcement in announcements %}
        <div class="notice-item">
            <div class="notice-item-text text-pre-wrap">{{ announcement.message }}</div>
            <div class="notice-item-meta">Posted {{ announcement.created_at }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
/* Room Issues Summary */
.room-issues-summary {
    background: var(--bg-white);
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.summary-heading {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0 0 16px 0;
}

.room-issues-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
}

.room-issue-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--bg-light);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 13px;
}

.room-issue-chip.hot-water-chip {
    background: #E3F2FD;
    border-color: #2196F3;
}

.room-issue-chip .room-number {
    font-weight: 700;
    color: var(--text-dark);
}

.room-issue-chip .issue-indicator {
    font-size: 14px;
}

.room-issue-chip .issue-type-label {
    font-size: 11px;
    color: var(--text-muted);
}

.summary-action {
    margin-top: 12px;
    text-align: right;
}

/* Hot Water Alert Card */
.alert-card-hot-water {
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    border: 2px solid #2196F3;
}

.icon-hot-water {
    font-size: 24px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Overview Auto-Refresh Logic
    const REFRESH_INTERVAL_MS = 30000; // 30 seconds

    async function updateOverviewStats() {
        try {
            const response = await fetch('/api/overview-alerts');
            if (!response.ok) return;

            const data = await response.json();

            // Update Counts
            const countOOO = document.getElementById('count-ooo');
            const cardOOO = document.getElementById('card-ooo');
            if (countOOO && cardOOO) {
                countOOO.textContent = data.room_out_of_order_count;
                cardOOO.classList.toggle('hidden', data.room_out_of_order_count === 0);
            }

            const countHotWater = document.getElementById('count-hot-water');
            const cardHotWater = document.getElementById('card-hot-water');
            if (countHotWater && cardHotWater) {
                countHotWater.textContent = data.hot_water_issue_count;
                cardHotWater.classList.toggle('hidden', data.hot_water_issue_count === 0);
            }

            const countLimitedUse = document.getElementById('count-limited-use');
            const cardLimitedUse = document.getElementById('card-limited-use');
            if (countLimitedUse && cardLimitedUse) {
                countLimitedUse.textContent = data.room_limited_use_count;
                cardLimitedUse.classList.toggle('hidden', data.room_limited_use_count === 0);
            }

            const countWakeup = document.getElementById('count-wakeup');
            const cardWakeup = document.getElementById('card-wakeup');
            if (countWakeup && cardWakeup) {
                countWakeup.textContent = data.wakeup_alert_count;
                cardWakeup.classList.toggle('hidden', data.wakeup_alert_count === 0);
            }

            const countDNR = document.getElementById('count-dnr');
            if (countDNR) {
                countDNR.textContent = data.active_dnr_count;
            }

            const countMaintenance = document.getElementById('count-maintenance');
            if (countMaintenance) {
                countMaintenance.textContent = data.open_maintenance_count;
            }

        } catch (error) {
            console.error('Failed to update overview stats:', error);
        }
    }

    // Start polling
    setInterval(updateOverviewStats, REFRESH_INTERVAL_MS);
</script>
{% endblock %}
