{% extends "base.html" %}

{% block title %}Maintenance Issues{% endblock %}

{% block page_title %}Maintenance Issues{% endblock %}

{% block page_subtitle %}
<div class="page-subtitle">Open Issues and Status Tracking</div>
{% endblock %}

{% block page_actions %}
<!-- Filters moved to page header for better visibility -->
<div class="filter-group">
    <a class="filter-btn {% if status_filter == 'default' %}active{% endif %}" href="/maintenance">Open + In Progress</a>
    <a class="filter-btn {% if status_filter == 'open' %}active{% endif %}" href="/maintenance?status=open">Open</a>
    <a class="filter-btn {% if status_filter == 'in_progress' %}active{% endif %}" href="/maintenance?status=in_progress">In Progress</a>
    <a class="filter-btn {% if status_filter == 'blocked' %}active{% endif %}" href="/maintenance?status=blocked">Blocked</a>
    <a class="filter-btn {% if status_filter == 'completed' %}active{% endif %}" href="/maintenance?status=completed">Completed</a>
    <a class="filter-btn {% if status_filter == 'all' %}active{% endif %}" href="/maintenance?status=all">All</a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Filter buttons in header */
    .filter-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content h2 {
        margin: 0 0 1rem 0;
    }

    .warning-text {
        color: #dc3545;
        font-weight: 600;
    }

    .modal-hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="quick-action-layout">
    <div class="quick-action-primary">
        <div class="maintenance-list">
            <h2>Maintenance Items</h2>
            {% if items %}
            {% for item in items %}
            <div class="maintenance-card">
                <div class="maintenance-card-header">
                    <div>
                        <div class="maintenance-title">{{ item.title }}</div>
                        {% if item.location %}
                        <div class="maintenance-location">{{ item.location }}</div>
                        {% endif %}
                    </div>
                    <div class="maintenance-meta">
                        <span class="status-badge {{ item.status }}">{{ item.status }}</span>
                        <span class="maintenance-priority priority-{{ item.priority }}">{{ item.priority }}</span>
                    </div>
                </div>
                {% if item.description %}
                <div class="maintenance-description text-pre-wrap">{{ item.description }}</div>
                {% endif %}
                <div class="maintenance-dates">
                    <span>Created: {{ item.created_at }}</span>
                    {% if item.updated_at %}<span>Updated: {{ item.updated_at }}</span>{% endif %}
                    {% if item.completed_at %}<span>Completed: {{ item.completed_at }}</span>{% endif %}
                </div>
                {% if item.is_editable %}
                <div class="maintenance-edit-actions">
                    <a class="btn btn-secondary" href="/maintenance?edit={{ item.id }}">Edit Details</a>
                    <button type="button" class="btn btn-destructive" onclick="confirmDeleteMaintenance({{ item.id }}, '{{ item.title }}')">Delete</button>
                </div>
                {% endif %}
                {% if editable_id == item.id and item.is_editable %}
                <form class="maintenance-edit-form" method="POST" action="/maintenance/{{ item.id }}/edit">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Title *</label>
                            <input type="text" name="title" required value="{{ item.title }}" placeholder="AC not cooling">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" name="location" value="{{ item.location }}" placeholder="Room 214" title="Location">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="priority-{{ item.id }}">Priority</label>
                            <select id="priority-{{ item.id }}" name="priority">
                                <option value="low" {% if item.priority=='low' %}selected{% endif %}>Low</option>
                                <option value="medium" {% if item.priority=='medium' %}selected{% endif %}>Medium</option>
                                <option value="high" {% if item.priority=='high' %}selected{% endif %}>High</option>
                                <option value="urgent" {% if item.priority=='urgent' %}selected{% endif %}>Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" placeholder="Add any helpful details..." title="Description">{{ item.description }}</textarea>
                    </div>
                    <div class="form-actions">
                        <a class="btn btn-secondary" href="/maintenance">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
                {% endif %}
                <form class="maintenance-status-form" method="POST" action="/maintenance/{{ item.id }}/status">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <label class="visually-hidden" for="status-{{ item.id }}">Update status</label>
                    <select id="status-{{ item.id }}" name="status">
                        <option value="open" {% if item.status=='open' %}selected{% endif %}>Open</option>
                        <option value="in_progress" {% if item.status=='in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="blocked" {% if item.status=='blocked' %}selected{% endif %}>Blocked</option>
                        <option value="completed" {% if item.status=='completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <button type="submit" class="btn btn-secondary">Update Status</button>
                </form>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <h3>No maintenance items</h3>
                <p>Use the form on the right to report the first issue.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="quick-action-secondary">
        <div class="maintenance-form">
            <h2>Report Maintenance Issue</h2>
            <form method="POST" action="/maintenance">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-row">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" name="title" required placeholder="AC not cooling">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="location" placeholder="Room 214">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="priority-select">Priority</label>
                        <select id="priority-select" name="priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" placeholder="Add any helpful details..."></textarea>
                    <small class="form-hint">Details can be adjusted briefly after submission.</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Maintenance Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay modal-hidden" id="delete-maintenance-modal">
    <div class="modal-content">
        <h2>Confirm Delete</h2>
        <p>Are you sure you want to permanently delete the maintenance item: <strong id="delete-maintenance-title"></strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
        <form method="POST" id="delete-maintenance-form" action="">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteMaintenanceModal()">Cancel</button>
                <button type="submit" class="btn btn-destructive">Delete Item</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function confirmDeleteMaintenance(itemId, title) {
        var modal = document.getElementById('delete-maintenance-modal');
        var titleDisplay = document.getElementById('delete-maintenance-title');
        var deleteForm = document.getElementById('delete-maintenance-form');

        titleDisplay.textContent = title;
        deleteForm.action = '/maintenance/' + itemId + '/delete';
        modal.classList.remove('modal-hidden');
    }

    function closeDeleteMaintenanceModal() {
        var modal = document.getElementById('delete-maintenance-modal');
        modal.classList.add('modal-hidden');
    }

    // Close modal on background click
    var maintenanceModal = document.getElementById('delete-maintenance-modal');
    if (maintenanceModal) {
        maintenanceModal.addEventListener('click', function (e) {
            if (e.target === this) {
                closeDeleteMaintenanceModal();
            }
        });
    }
</script>
{% endblock %}
