{% extends "base.html" %}

{% block title %}Wake-up Calls{% endblock %}

{% block page_title %}Wake-up Calls{% endblock %}

{% block page_actions %}
<a href="{{ url_for('wakeup_calls_list', all=1) }}" class="btn btn-secondary">View All History</a>
{% endblock %}

{% block content %}
<div class="wakeup-container">

    <!-- Pending Calls -->
    <div class="card">
        <h3>Pending Calls</h3>

        {% if request.args.get('success') %}
        <div class="alert alert-success">{{ request.args.get('success') }}</div>
        {% endif %}
        {% if request.args.get('error') %}
        <div class="alert alert-danger">{{ request.args.get('error') }}</div>
        {% endif %}

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Room</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in calls %}
                    {% if call.status == 'pending' %}
                    <tr
                        class="{% if call.call_date < today or (call.call_date == today and call.call_time < now_time) %}overdue-row{% endif %}">
                        <td>{{ call.call_date }}</td>
                        <td>{{ call.call_time }}</td>
                        <td><strong>{{ call.room_number }}</strong></td>
                        <td>
                            <span class="status-indicator status-pending">Pending</span>
                        </td>
                        <td>
                            <form action="{{ url_for('update_wakeup_call', call_id=call.id) }}" method="POST"
                                class="inline-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="status" value="completed">
                                <button type="submit" class="btn btn-success btn-sm">Complete</button>
                            </form>
                            <form action="{{ url_for('update_wakeup_call', call_id=call.id) }}" method="POST"
                                class="inline-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="status" value="failed">
                                <button type="submit" class="btn btn-danger btn-sm">Fail</button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}

                    {% set pending_count = calls|selectattr('status', 'equalto', 'pending')|list|length %}
                    {% if pending_count == 0 %}
                    <tr>
                        <td colspan="5" class="text-center">No pending calls.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add New Call -->
    <div class="card card-mt">
        <h3>Schedule Wake-up Call</h3>
        <form action="{{ url_for('add_wakeup_call') }}" method="POST" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label for="room_number">Room Number</label>
                <input type="text" id="room_number" name="room_number" required placeholder="101">
            </div>

            <div class="form-group">
                <label for="call_date">Date</label>
                <input type="date" id="call_date" name="call_date" required value="{{ today }}">
            </div>

            <div class="form-group">
                <label for="call_time">Time</label>
                <input type="time" id="call_time" name="call_time" required>
            </div>

            <button type="submit" class="btn btn-primary">Schedule Call</button>
        </form>
    </div>

    <!-- Recent History (Completed/Failed) -->
    <div class="card card-mt">
        <h3>Recent History</h3>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Room</th>
                        <th>Status</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in calls %}
                    {% if call.status != 'pending' %}
                    <tr>
                        <td>{{ call.call_date }}</td>
                        <td>{{ call.call_time }}</td>
                        <td>{{ call.room_number }}</td>
                        <td>
                            <span class="status-indicator status-{{ call.status }}">{{ call.status|title }}</span>
                        </td>
                        <td>{{ call.outcome_note or '' }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

{% endblock %}